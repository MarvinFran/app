{"version":3,"file":"blob_writer.umd.js","sources":["blob_writer.js"],"sourcesContent":["/*jslint browser */\nimport {Capacitor, registerPlugin} from \"@capacitor/core\";\nimport {Filesystem} from \"@capacitor/filesystem\";\n\nconst BlobWriter = registerPlugin(\"BlobWriter\");\n\nfunction array_buffer_to_base64(buffer) {\n    const bytes = new Uint8Array(buffer);\n    let binary_string = \"\";\n    let byte_nr = 0;\n    while (true) {\n        if (byte_nr >= bytes.byteLength) {\n            break;\n        }\n        binary_string += String.fromCharCode(bytes[byte_nr]);\n        byte_nr += 1;\n    }\n    return window.btoa(binary_string);\n}\n\nfunction append_blob(directory, path, blob) {\n    if (blob.size === 0) {\n        return Promise.resolve();\n    }\n\n// By choosing a chunk size which is a multiple of 3, we avoid a bug in\n// Filesystem.appendFile, only on the web platform, which corrupts files by\n// inserting Base64 padding characters within the file. See\n// https://github.com/ionic-team/capacitor-plugins/issues/649.\n\n    const chunk_size = 3 * 128 * 1024;\n    const chunk_blob = blob.slice(0, chunk_size);\n\n// Read the Blob as an ArrayBuffer, then append it to the file on disk.\n\n    return new window.Response(chunk_blob).arrayBuffer().then(\n        function append_chunk_to_file(buffer) {\n            return Filesystem.appendFile({\n                directory,\n                path,\n                data: array_buffer_to_base64(buffer)\n            });\n        }\n    ).then(function write_remaining() {\n        return append_blob(directory, path, blob.slice(chunk_size));\n    });\n}\n\n\nfunction write_file_via_bridge({\n    path,\n    directory,\n    blob,\n    recursive\n}) {\n\n// Firstly, create & truncate the file.\n\n    return Filesystem.writeFile({\n        directory,\n        path,\n        recursive,\n        data: \"\"\n    }).then(function ({uri}) {\n\n// Now write the file incrementally so we do not exceed our memory limits when\n// attempting to Base64 encode the entire Blob at once.\n\n        return append_blob(directory, path, blob).then(function () {\n            return uri;\n        });\n    });\n}\n\nfunction write_blob(options) {\n    const {\n        path,\n        directory,\n        blob,\n        recursive,\n        on_fallback\n    } = options;\n    if (Capacitor.platform !== \"ios\" && Capacitor.platform !== \"android\") {\n        return write_file_via_bridge(options);\n    }\n    return Promise.all([\n        BlobWriter.get_config(),\n        Filesystem.getUri({path, directory})\n    ]).then(function on_success([config, file_info]) {\n        const {base_url, auth_token} = config;\n        const absolute_path = file_info.uri.replace(\"file://\", \"\");\n        return Promise.all([\n            fetch(\n                base_url + absolute_path + (\n                    recursive\n                    ? \"?recursive=true\"\n                    : \"\"\n                ),\n                {\n                    headers: {authorization: auth_token},\n                    method: \"put\",\n                    body: blob\n                }\n            ),\n            Promise.resolve(file_info)\n        ]);\n    }).then(function ([response, file_info]) {\n        if (response.status !== 204) {\n            throw new Error(\"Bad HTTP status: \" + response.status);\n        }\n        return file_info.uri;\n    }).catch(function on_fail(error) {\n        if (on_fallback !== undefined) {\n            on_fallback(error);\n        }\n        return write_file_via_bridge(options);\n    });\n}\n\nexport default Object.freeze(write_blob);\n"],"names":["registerPlugin","Filesystem","Capacitor"],"mappings":"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"}